<% if @conversation.nil? || @conversation.new_record? %>
  <div class="max-w-4xl mx-auto py-8 px-4">
    <div class="bg-red-100 dark:bg-red-900/30 border border-red-400 dark:border-red-600 text-red-700 dark:text-red-300 px-4 py-3 rounded-lg" role="alert">
      <p class="font-bold"><%= t("conversations.show.error_title") %></p>
      <p><%= t("conversations.show.not_found") %></p>
      <%= link_to t("conversations.show.back_to_request"), @request, class: "text-red-800 dark:text-red-400 underline mt-2 inline-block hover:text-red-900 dark:hover:text-red-300 transition-colors" %>
    </div>
  </div>
<% else %>
  <div class="max-w-4xl mx-auto py-8 px-4 sm:px-6 lg:px-8"
       data-controller="conversation"
       data-conversation-id-value="<%= @conversation.id %>"
       data-conversation-current-user-id-value="<%= current_user.id %>">

    <!-- Header -->
    <div class="bg-white dark:bg-gray-800 rounded-t-xl shadow-md p-4 sm:p-6 border-b border-gray-200 dark:border-gray-700">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <h1 class="text-lg sm:text-xl font-bold text-gray-900 dark:text-gray-100">
            <%= t("conversations.show.chat_title") %>
            <%= link_to @request.title, @request, class: "text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors" %>
          </h1>
          <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
            <%= t("conversations.show.participants") %>
            <span class="font-semibold"><%= @conversation.asker.username %></span>
            <%= t("conversations.show.and") %>
            <span class="font-semibold"><%= @conversation.helper.username %></span>
          </p>
        </div>
        <%= link_to t("conversations.show.back_to_request"), @request,
            class: "text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 text-sm font-medium transition-colors",
            "aria-label": t("conversations.show.back_to_request") %>
      </div>
    </div>

    <!-- Messages container - responsive height -->
    <div id="conversation_<%= @conversation.id %>"
         data-conversation-target="messages"
         data-current-user-id="<%= current_user.id %>"
         class="bg-white dark:bg-gray-800 shadow-md p-4 sm:p-6 space-y-4 h-[60vh] min-h-[300px] max-h-[600px] overflow-y-auto">

      <div id="messages">
        <% @messages.each do |message| %>
          <%= render partial: "messages/message", locals: { message: message, viewing_user_id: current_user.id } %>
        <% end %>
      </div>
    </div>

    <!-- Message form -->
    <div class="bg-white dark:bg-gray-800 rounded-b-xl shadow-md p-4 sm:p-6 border-t border-gray-200 dark:border-gray-700">
      <%= form_with(
        model: @message,
        url: conversation_messages_path(@conversation),
        data: {
          conversation_target: "form",
          action: "turbo:submit-end->conversation#clearForm"
        }
      ) do |f| %>
        <div class="flex flex-col sm:flex-row items-stretch sm:items-end gap-3">
          <%= f.text_area :body,
              rows: 2,
              placeholder: t("conversations.show.placeholder"),
              "aria-label": t("conversations.show.placeholder"),
              data: {
                conversation_target: "input",
                action: "keydown->conversation#handleKeydown"
              },
              class: "flex-1 rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 dark:placeholder-gray-400 shadow-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-colors resize-none" %>

          <%= f.submit t("conversations.show.send"),
              data: { conversation_target: "submit" },
              class: "px-6 py-2.5 bg-blue-600 text-white font-semibold rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" %>
        </div>
      <% end %>
    </div>
  </div>
<% end %>
