<% content_for(:page_title, "Report ##{@report.id}") %>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

  <div class="lg:col-span-2 space-y-6">
    <div class="bg-white shadow rounded-lg overflow-hidden">
      <div class="px-6 py-5 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-bold text-gray-900">
            Report #<%= @report.id %> - <span class="capitalize"><%= @report.report_type %></span>
          </h2>
          <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium <%= 
            case @report.status
            when 'pending' then 'bg-yellow-100 text-yellow-800'
            when 'investigating' then 'bg-blue-100 text-blue-800'
            when 'resolved' then 'bg-green-100 text-green-800'
            when 'dismissed' then 'bg-gray-100 text-gray-800'
            end
          %>">
            <%= @report.status.humanize %>
          </span>
        </div>
      </div>
      <div class="px-6 py-5">
        <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-6">
          <div>
            <dt class="text-sm font-medium text-gray-500">Reported By</dt>
            <dd class="mt-1 text-sm text-gray-900">
              <%= link_to @report.reporter.username, admin_user_path(@report.reporter), class: "text-indigo-600 hover:underline" %>
            </dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">Reported User</dt>
            <dd class="mt-1 text-sm text-gray-900">
              <% if @report.reported_user %>
                <%= link_to @report.reported_user.username, admin_user_path(@report.reported_user), class: "text-red-600 hover:underline" %>
              <% else %>
                <span class="text-gray-500">N/A</span>
              <% end %>
            </dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">Reported At</dt>
            <dd class="mt-1 text-sm text-gray-900"><%= l(@report.created_at, format: :long) %></dd>
          </div>
          <div>
            <dt class="text-sm font-medium text-gray-500">Reportable Type</dt>
            <dd class="mt-1 text-sm text-gray-900"><%= @report.reportable_type %></dd>
          </div>
          <div class="sm:col-span-2">
            <dt class="text-sm font-medium text-gray-500">Reason</dt>
            <dd class="mt-1 text-sm text-gray-900 bg-gray-50 border border-gray-200 rounded-md p-3">
              <%= @report.reason %>
            </dd>
          </div>
        </dl>
      </div>
    </div>

    <div class="bg-white shadow rounded-lg overflow-hidden">
      <div class="px-6 py-5 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">Reported Content</h3>
      </div>
      <div class="px-6 py-5">
        <% if @reportable %>
          <% if @reportable.is_a?(Request) %>
            <h4 class="font-semibold text-gray-800"><%= @reportable.title %></h4>
            <p class="text-sm text-gray-600 mt-2 bg-gray-50 p-3 rounded-md border"><%= @reportable.description %></p>
            <%= link_to "View Request", request_path(@reportable), class: "text-indigo-600 text-sm mt-2 inline-block", target: "_blank" %>
          <% elsif @reportable.is_a?(Offer) %>
            <p class="text-sm text-gray-600 mt-2 bg-gray-50 p-3 rounded-md border"><%= @reportable.message %></p>
            <%= link_to "View Offer's Request", request_path(@reportable.request), class: "text-indigo-600 text-sm mt-2 inline-block", target: "_blank" %>
          <% elsif @reportable.is_a?(User) %>
            <p class="text-lg font-semibold"><%= @reportable.username %></p>
            <%= link_to "View Profile", user_path(@reportable.username), class: "text-indigo-600 text-sm mt-2 inline-block", target: "_blank" %>
          <% end %>
        <% else %>
          <p class="text-red-600">The reported content has been deleted.</p>
        <% end %>
      </div>
    </div>
  </div>

  <div class="lg:col-span-1">
    <div class="bg-white shadow rounded-lg space-y-6 p-6 sticky top-6">
      <h3 class="text-lg font-medium text-gray-900">Moderation Actions</h3>

      <% if @report.pending? %>
        <%= button_to "Start Investigation", investigate_admin_report_path(@report), 
            method: :patch,
            class: "w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700" %>
      <% end %>

      <% if @report.investigating? %>
        <%= form_with(url: resolve_admin_report_path(@report), method: :patch, local: true, class: "space-y-4") do |f| %>
          <div>
            <%= f.label :resolution_note, "Resolution Note (Required)", class: "block text-sm font-medium text-gray-700" %>
            <%= f.text_area :resolution_note, rows: 4, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500", required: true %>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700">Action (Optional)</label>
            <div class="space-y-2 mt-1">
              <% if @reportable && !@reportable.is_a?(User) %>
                <div class="flex items-center">
                  <%= f.radio_button :action_type, 'delete_content', class: "h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" %>
                  <%= f.label :action_type_delete_content, "Delete Content", class: "ml-3 block text-sm text-gray-700" %>
                </div>
              <% end %>
              <% if @report.reported_user && !@report.reported_user.banned? %>
                <div class="flex items-center">
                  <%= f.radio_button :action_type, 'ban_user', class: "h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" %>
                  <%= f.label :action_type_ban_user, "Ban Reported User", class: "ml-3 block text-sm text-gray-700" %>
                </div>
              <% end %>
              <div class="flex items-center">
                <%= f.radio_button :action_type, 'warn_user', class: "h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" %>
                <%= f.label :action_type_warn_user, "Warn User (Sends Notification)", class: "ml-3 block text-sm text-gray-700" %>
              </div>
              <div class="flex items-center">
                <%= f.radio_button :action_type, 'none', checked: true, class: "h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" %>
                <%= f.label :action_type_none, "No Action", class: "ml-3 block text-sm text-gray-700" %>
              </div>
            </div>
          </div>
          
          <%= f.submit "Resolve Report", class: "w-full inline-flex justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700" %>
        <% end %>

        <%= form_with(url: dismiss_admin_report_path(@report), method: :patch, local: true, class: "mt-4") do |f| %>
          <div class="mb-2">
            <%= f.label :resolution_note, "Dismissal Note (Optional)", class: "block text-sm font-medium text-gray-700" %>
            <%= f.text_area :resolution_note, rows: 2, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500", placeholder: "e.g., False report" %>
          </div>
          <%= f.submit "Dismiss Report", data: { turbo_confirm: "Are you sure you want to dismiss this report?" }, class: "w-full inline-flex justify-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" %>
        <% end %>
      <% end %>
      
      <% if @report.resolved? || @report.dismissed? %>
        <div class="border-t border-gray-200 pt-4">
          <dl>
            <dt class="text-sm font-medium text-gray-500">Outcome</dt>
            <dd class="mt-1 text-sm font-medium <%= @report.resolved? ? 'text-green-600' : 'text-gray-600' %>">
              <%= @report.status.humanize %>
            </dd>
            
            <dt class="text-sm font-medium text-gray-500 mt-4">Resolver</dt>
            <dd class="mt-1 text-sm text-gray-900">
              <%= @report.resolver.username %>
            </dd>
            
            <dt class="text-sm font-medium text-gray-500 mt-4">Resolved At</dt>
            <dd class="mt-1 text-sm text-gray-900">
              <%= l(@report.resolved_at, format: :long) %>
            </dd>
            
            <% if @report.resolution_note.present? %>
              <dt class="text-sm font-medium text-gray-500 mt-4">Note</dt>
              <dd class="mt-1 text-sm text-gray-900 bg-gray-50 border border-gray-200 rounded-md p-3">
                <%= @report.resolution_note %>
              </dd>
            <% end %>
          </dl>
        </div>
      <% end %>
      
      <div class="mt-6 border-t pt-4">
        <%= link_to "â† Back to all reports", admin_reports_path, class: "text-sm text-gray-600 hover:text-indigo-600" %>
      </div>
    </div>
  </div>

</div>
